# kubernetes架构

## 微服务架构

- 每个服务进行拆分(独立的域名,独立的数据库,独立的开发和维护人员),针对每个服务进行弹性伸缩架构

## Kubernetes架构

#### 工作节点

- `kubelet`:管理和维护当前节点的pod,确保它们按照预期运行(定期从api-server组件接收新的pod规范,并监控节点运行情况并汇报给api-server)
- `kube-proxy`:为pod提供网络代理和负载均衡等服务
- `container-runtime`(pod的运行环境)

#### 控制平面

- `Api-Server(核心)`
  - **接收信息**:接收从各个node发送过来的状态信息,传送给控制平面上其他组件
  - **api接口**:提供开发者交互的api(如kubectl等),使得开发者能够控制整个集群(对所有组件进行增删改查)
  - **权限控制**:在访问集群api的时候进行身份校验,保证系统的安全性
- `Scheduler(sched)`:
  - 负责整个集群的**资源调度**功能,将**pod调度到最优的节点上**(更好地利用集群的资源)
- `Controller-Manager(c-m)`:保证集群中各种资源的实际状态与用户期望的一致
  - **监控**检测集群中的故障或者异常
  - 尽快进行**故障处理**(重启pod或者用备用pod替换)
- `etcd`:键值存储系统,记录整个**集群的状态信息**
  - 运行中组件的状态(运行时间,cpu,内存,ip等)
  - 故障信息和系统日志

#### Kubernetes组件

- Node: k8s集群中的一个节点

- Pod:k8s的最小调度单元
  - 一般情况下pod中只运行一个容器
  - sidecar:一个pod中运行多个容器,其中一个主服务容器和辅助容器(日志收集,服务监控,配置管理等)
  - pod的ip地址不固定经常发生变化(每次重启pod之后ip都会发生变化)



- Service:固定IP地址,将请求转发给pod
  - 内部服务(数据库,消息队列等)
  - 外部服务:使用nodePort(对外部开放IP+端口号)或者Ingress(配置转发规则,支持域名)
- Ingress:对外开放端口,配置路由将外部请求转发给内部组件(支持域名转发)



- ConfigMap:存储非机密性的配置数据,使得配置信息与容器镜像解耦(便于配置的修改)
- Secret:ConfigMap+base64进行存储



- Volume:持久化存储(容器被销毁或者重启之后,依然能正常运行)



- Deployment:一个应用程序无状态pod的集合(应用程序及其很多副本)
  - 支持滚动更新(升级应用版本,减少应用停机时间)
  - 无状态:不同pod之间可以相互替换
- StatefulSet:一个应用程序有状态pod的集合
  - 固定IP标识
  - 有状态:每个pod都是独特的,不同pod之间不能相互替换